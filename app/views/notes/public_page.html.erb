
<!DOCTYPE html>

<html>

<head>

  <meta charset="UTF-8">
  <title>公開ページ - <%= @user.first_name %> <%= @user.last_name %></title>


  <style>

/* ✅ 全体の表示を左右5%ずつ空ける */
body {
  margin-left: 5%;
  margin-right: 5%;
  font-family: Arial, sans-serif;
  font-size: 12px;
}

/* ✅ ヘッダー、タイトル、テーブルの基本スタイル */
h1, h2, h3 {
  color: #333;
}

table {
  border-collapse: collapse;
  margin-top: 10px;
  width: 100%; /* ✅ テーブルは最大幅（親要素の幅100%を使用） */
}

table, th, td {
  border: 1px solid black;
}

th, td {
  padding: 8px;
  text-align: left;
  word-wrap: break-word;
  overflow-wrap: break-word;
  white-space: normal;
}

/* ✅ 水色背景エリアのレイアウト調整（左右5%の余白を維持） */
.readonly-container {
  background-color: #E0F7FA; /* ✅ 薄めの水色 */
  padding: 20px;
  border-radius: 5px;
  margin-top: 20px;
  width: 100%; /* ✅ 親要素の幅いっぱい */
  overflow: hidden; /* ✅ はみ出し防止 */
  margin-left: auto;
  margin-right: auto;
}

/* ✅ `.readonly-content` も親要素にフィット */
.readonly-content {
  background-color: inherit; /* ✅ 親要素の背景色を継承 */
  padding: 15px;
  border-radius: 5px;
  width: 100%; /* ✅ 親要素いっぱい */
  word-wrap: break-word;
  overflow-wrap: break-word;
}

/* ✅ hr線の幅を統一（左右5%空ける） */
hr {
  width: 100%; /* ✅ 画面いっぱいに表示 */
  margin-left: auto;
  margin-right: auto;
  border: 1px solid #ccc; /* ✅ 線のスタイルはそのまま */
}


  </style>

  </head>

<body style="margin-left: 10%;">





<!--ここからが本文です----------------------------------------------------------------->





<p>　</p>

<p style="color: blue; font-size: 150%; display: block; width: fit-content; margin-left: auto; margin-right: 20%;">
  <%= link_to "PDFで保存", download_pdf_note_path(@user, format: :pdf), class: "btn btn-primary" %>
</p>


<h2 style="display: inline;">　　このページは、 <%= @user.first_name %> <%= @user.last_name %> さんの公開ページです。</h2>
<div style="display: flex; align-items: center; gap: 10px; margin-top: 5px;">
  <input type="text" id="publicPageUrl" value="<%= request.original_url %>" readonly 
    style="flex: 1; max-width: 480px;">
  <button onclick="copyPublicPageUrl()">このページのURLをコピー</button>
</div>


<p>　</p>






<p style="text-align: left;">
  <%= button_to "あなたの個人ページに戻る", notes_path, 
    method: :get, 
    class: "btn btn-secondary", 
    id: "return-to-notes", 
    form: { style: "display: inline; margin-left: 50px;" } %>
</p>


<script>
  document.addEventListener("DOMContentLoaded", function () {
    // ✅ URLに ?reload=true がついていたらリロードする
    if (window.location.search.includes("reload=true")) {
      window.history.replaceState({}, document.title, window.location.pathname); // クエリを消す
      location.reload();
    }
  });

  // ✅ ボタンを押したら、個人ページに移動し、その後リロードする
  document.getElementById("return-to-notes").addEventListener("click", function(event) {
    event.preventDefault(); // 通常のリンク動作を止める
    window.location.href = "<%= notes_path %>?reload=true"; // クエリをつけて移動
  });
</script>





<p>　</p>

<p><strong>　　ページ公開者　：　</strong> <%= @user.first_name %> <%= @user.last_name %>　　　最終アクセス時間：
  <%= @view_accesses.select { |va| va.viewer_id == @user.id }
      .max_by(&:last_accessed_at)&.last_accessed_at&.in_time_zone('Asia/Tokyo')&.strftime('%Y-%m-%d %H:%M') || 'データなし' %>
</p>
<p><strong>　　現在の閲覧者　：　</strong> <%= @viewer.first_name %> <%= @viewer.last_name %>　　　最終アクセス時間：
  <%= @view_accesses.find { |va| va.viewer_id == @viewer.id }&.last_accessed_at&.in_time_zone('Asia/Tokyo')&.strftime('%Y-%m-%d %H:%M') || 'データなし' %>
</p>

<p>　</p>
<p>　</p>

<h3>　　このページの閲覧履歴詳細</h3>

<% if @view_accesses.any? %>
  <% sorted_view_accesses = @view_accesses.map do |access|
    viewer = access.viewer
    view_request = ViewRequest.find_by(user_id: viewer.id, first_name: @user.first_name, last_name: @user.last_name, birthday: @user.birthday)
    relationship = view_request&.relationship.presence || "本人"
    {
      viewer: viewer,
      relationship: relationship,
      last_accessed_at: access.last_accessed_at,
      access_count: access.access_count
    }
  end %>

  <% relationship_order = ["本人", "夫", "妻", "長男", "二男", "三男", "長女", "二女", "三女", "本人の父母", "本人の兄弟", "その他"] %>

  <% sorted_view_accesses.sort_by! { |va| relationship_order.index(va[:relationship]) || relationship_order.length } %>

  <table border="1">
    <tr>
      <th>閲覧ユーザー</th>
      <th>続柄</th>
      <th>最終アクセス</th>
      <th>アクセス回数</th>
      <th>メールアドレス</th>
      <th>生年月日</th>
      <th>血液型</th>
      <th>住所</th>
      <th>電話番号</th>
    </tr>
    <% sorted_view_accesses.each do |va| %>
      <tr>
        <td><%= va[:viewer].first_name %>　(<%= va[:viewer].first_name_furigana %>) 
          　<%= va[:viewer].last_name %>　(<%= va[:viewer].last_name_furigana %>)</td>
        <td><%= va[:relationship] %></td>
        <td><%= va[:last_accessed_at]&.in_time_zone('Asia/Tokyo')&.strftime('%Y-%m-%d %H:%M') || 'データなし' %></td>
        <td><%= va[:access_count] %> 回</td>
        <td><%= va[:viewer].email %></td>
        <td><%= va[:viewer].birthday.strftime('%Y-%m-%d') if va[:viewer].birthday %></td>
        <td><%= va[:viewer].blood_type %></td>
        <td><%= va[:viewer].address %></td>
        <td><%= va[:viewer].phone_number %></td>
      </tr>
    <% end %>
  </table>
<% else %>
  <p>まだ誰にも閲覧されていません。</p>
<% end %>

<script>
  function copyPublicPageUrl() {
    var urlField = document.getElementById("publicPageUrl");
    urlField.select();
    urlField.setSelectionRange(0, 99999);
    document.execCommand("copy");
    alert("URLをコピーしました: " + urlField.value);
  }
</script>

<p>　</p>
<p style="color: red; font-weight: bold; width: fit-content; margin-left: auto; margin-right: 20%;">
  ※閲覧を許可した覚えのないユーザーが表示されている場合は、①<u>このページを保存</u>のうえ、②<u>この行より上の情報を開発者まで連絡して</u>ください。
</p>
<p style="color: red; font-weight: bold; width: fit-content; margin-left: auto; margin-right: 20%;">
  ※パスワード変更を行っても、ページURLは変更されません。③<u>このアカウントを削除</u>後、④<u>再度、新規登録から作り直して</u>ください。
</p>




<p>　</p>
<p>　</p>
<p>　</p>

<hr>


<p>　</p>
<p>　</p>



<h3>　　<%= @user.first_name %> <%= @user.last_name %> さんが許可した人の一覧</h3>

<% if @user.view_permissions.any? %>
  <table border="1">
    <tr>
      <th>許可された閲覧者</th>
      <th>生年月日</th>
      <th>血液型</th>
    </tr>
    <% @user.view_permissions.each do |vp| %>
      <tr>
        <td>
          <%= vp.first_name %> (<%= vp.first_name_furigana %>) 
          <%= vp.last_name %> (<%= vp.last_name_furigana %>)
        </td>
        <td><%= vp.birthday.strftime('%Y-%m-%d') if vp.birthday %></td>
        <td><%= vp.blood_type %></td>
      </tr>
    <% end %>
  </table>
<% else %>
  <p>現在、許可されている閲覧者はいません。</p>
<% end %>


<p>　</p>



<h3>　　<%= @user.first_name %> <%= @user.last_name %> さんが閲覧したいと検索をかけた人の一覧</h3>

<% if @user.view_requests.any? %>
  <table border="1">
    <tr>
      <th>閲覧したい対象者</th>
      <th>生年月日</th>
      <th>血液型</th>
      <th>公開ページURL</th>
    </tr>
    <% @user.view_requests.each do |vr| %>
      <tr>
        <td>
          <%= vr.first_name %> (<%= vr.first_name_furigana %>) 
          <%= vr.last_name %> (<%= vr.last_name_furigana %>)
        </td>
        <td><%= vr.birthday.strftime('%Y-%m-%d') if vr.birthday %></td>
        <td><%= vr.blood_type %></td>
        <td>
          <% access = ViewAccess.find_by(viewer_id: @user.id, owner_id: vr.user_id) %>
          <% if access&.public_page_url.present? %>
            <a href="<%= access.public_page_url %>" target="_blank" rel="noopener noreferrer">
              <%= access.public_page_url %>
            </a>
          <% else %>
            未取得
          <% end %>
        </td>
      </tr>
    <% end %>
  </table>
<% else %>
  <p>現在、閲覧したい対象者の登録はありません。</p>
<% end %>



<p>　</p>
<p>　</p>
<p>　</p>

<hr>


<p>　</p>
<p>　</p>


<p style="font-weight: bold; color: blue; text-decoration: underline;">
  ↓↓↓以下は閲覧専用であり、編集やリンク先への移動は一切できません。↓↓↓
</p>

<p>　</p>






<!--水色背景  適用開始----------------------------------------------------------------->


<div id="readonly-child-section" class="readonly-container">
ここから水色




  <div class="readonly-content">
    <%= render template: "notes/index", locals: { current_user: @user, readonly: true } %>
  </div>






<!--水色背景  適用終了----------------------------------------------------------------->
ここから空白
  <br>
  <br>

<p style="font-weight: bold; color: blue; text-decoration: underline;">
  ※本日時刻以降の変更内容については保証されません。<br>
  ※意思表示に関し、一定の遺言効果や尊重がなされる可能性はありますが、法的な遺言効果を約束するものではありません。
</p>

<br>
<br>
