
<br>

<h1>
  <%= current_user.first_name %> <%= current_user.last_name %> さんの個人ページーーーーーーーーーーーーーーーーーーーーーーーーーーー
</h1>

<br>

<div class="button-container">
  <%= link_to "⭐️閲覧者から見た『あなた』の公開ページ",
              public_page_path(current_user.uuid, (current_user.id + 150150)),
              class: "btn btn-primary" %>
  <br>
  <br>
  <%= button_to " ログアウト ", destroy_user_session_path, method: :delete, class: "btn btn-danger" %>
</div>

<br>
ーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーー
<br>
<br>

<div class="tabs">
  <button id="parent-tab" class="active" onclick="showSection('parent')">記入者（親側）として利用する</button>
  <button id="child-tab" onclick="showSection('child')">閲覧者（子側）として利用する</button>
</div>

<br>
ーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーー
<br>
<br>

<!-- 親側（記入者）画面 -->
<div id="parent-section">
  <div class="sub-tabs">
    （親側）<br>
    <button id="info-tab" class="active" onclick="showSubSection('info')">①あなたの登録情報の変更</button>
    <button id="permission-tab" onclick="showSubSection('permission')">②閲覧を許可する対象者を登録</button>
    <button id="notes-tab" onclick="showSubSection('notes')">③ノートを記述</button>
    <br>
    <br>
ーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーー
<br>
<br>
  </div>

  <!-- ①ユーザ新規登録情報 -->
  <div id="info-section">
  <h3>①<%= current_user.first_name %> <%= current_user.last_name %> さんの登録情報（※空欄不可）</h3>
  <br>
  <h3>※<b>閲覧申請者に要求する情報としても使用</b>しますので、間違いが無いように記入してください。</h3>
  <h3>※旧字体・大文字・小文字・住所の表現などが少しでも異なると、閲覧権限を付与できません。</h3>
  <br>

<!-- ①ユーザ新規登録情報フォーム -->
   <%= form_with model: current_user, url: user_path(current_user), method: :patch, local: true do |f| %>
  <div>
    <%= f.label :email, "メールアドレス" %>
    <%= f.email_field :email, value: current_user.email, readonly: true %>
  </div>

  <div>
    <%= f.label :first_name, "苗字" %>
    <%= f.text_field :first_name, value: current_user.first_name %>
  </div>

  <div>
    <%= f.label :first_name_furigana, "苗字（ふりがな）" %>
    <%= f.text_field :first_name_furigana, value: current_user.first_name_furigana %>
  </div>

  <div>
    <%= f.label :last_name, "名前" %>
    <%= f.text_field :last_name, value: current_user.last_name %>
  </div>

  <div>
    <%= f.label :last_name_furigana, "名前（ふりがな）" %>
    <%= f.text_field :last_name_furigana, value: current_user.last_name_furigana %>
  </div>

  <div>
    <%= f.label :birthday, "生年月日" %>
    <%= f.date_select :birthday, start_year: 1900, end_year: Date.today.year, use_month_numbers: true %>
  </div>

  <div>
    <%= f.label :blood_type, "血液型" %>
    <%= f.select :blood_type, ["A", "B", "O", "AB"], include_blank: "選択してください" %>
  </div>

  <div>
    <%= f.label :phone_number, "電話番号" %>
    <%= f.text_field :phone_number, value: current_user.phone_number %>
  </div>

  <div>
    <%= f.label :address, "住所" %>
    <%= f.text_field :address, value: current_user.address %>
  </div>

  <br>
  <%= f.submit "登録情報の変更を保存" %>
  <br><br>
  ーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーー
  <br><br>
  </div>
<% end %>


  <!-- ②閲覧を許可する対象者を登録 -->
  <div id="permission-section" style="display: none;">
  <h3>②閲覧を許可する対象者を登録</h3>
  <br>
  <p>※下に登録したユーザー情報と<b>完全一致するユーザーだけに閲覧を許可</b>します。</p>
  <p>※旧字体・大文字・小文字・住所の表現などが少しでも異なっていると、閲覧権限を付与できません。</p>
  <br>

  <!-- ②閲覧を許可する対象者を登録フォーム -->
  <%= form_with model: ViewPermission.new, url: view_permissions_path, method: :post, local: true do |f| %>
    <div>
      <%= f.label :first_name, "苗字" %>
      <%= f.text_field :first_name %>
    </div>
    <div>
      <%= f.label :first_name_furigana, "苗字（ふりがな）" %>
      <%= f.text_field :first_name_furigana %>
    </div>
    <div>
      <%= f.label :last_name, "名前" %>
      <%= f.text_field :last_name %>
    </div>
    <div>
      <%= f.label :last_name_furigana, "名前（ふりがな）" %>
      <%= f.text_field :last_name_furigana %>
    </div>
    <div>
      <%= f.label :birthday, "生年月日" %>
      <%= f.date_select :birthday, start_year: 1900, end_year: Date.today.year, use_month_numbers: true %>
    </div>
    <div>
      <%= f.label :blood_type, "血液型" %>
      <%= f.select :blood_type, ["A", "B", "O", "AB"], include_blank: "選択してください" %>
    </div>
    <br>
    <%= f.submit "閲覧を許可する対象者を保存" %>
    <br><br>
    ーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーー
    <br><br>
    
    <!-- ②ーⅡ登録済みの許可対象者リスト -->
  <h3>登録済みの閲覧許可対象者</h3>
  <% if current_user.view_permissions.any? %>
    <table border="1">
      <tr>
        <th>苗字</th>
        <th>名前</th>
        <th>生年月日</th>
        <th>血液型</th>
        <th>削除</th>
      </tr>
      <% current_user.view_permissions.each do |vp| %>
        <tr>
          <td><%= vp.first_name %> (<%= vp.first_name_furigana %>)</td>
          <td><%= vp.last_name %> (<%= vp.last_name_furigana %>)</td>
          <td><%= vp.birthday.strftime('%Y-%m-%d') %></td>
          <td><%= vp.blood_type %></td>
          <td>削除</td>
        </tr>
      <% end %>
    </table>
  <% else %>
    <p>現在、登録されている閲覧許可対象者はありません。</p>
  <% end %>
  <br><br>
  ーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーー
</div>

      </div>
    <% end %>
  </div>
  

  <!-- ③ノートを記述 -->
  <div id="notes-section" style="display: none;">
    <h3>③ノートを記述</h3>
    <br>
    <p>※ここに遺言情報を記述できます。</p>
      <br>
      <br>
  ーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーー
      <br>
      <br>
  </div>
    </div>
    </div>
</div>






<!-- 子側（閲覧者）画面 -->
<div id="child-section" style="display: none;">
  <div class="sub-tabs">
    （子側）<br>
    <button id="search-tab" class="active" onclick="showChildSubSection('search')">①閲覧したい対象者（親側）の情報登録</button>
    <button id="result-tab" onclick="showChildSubSection('result')">②登録リストから公開ページへアクセス</button>
  </div>

<br>
<br>
ーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーー
<br>
<br>

  <!-- １親情報の登録 -->
  <div id="search-section">
    <h3>①親情報（閲覧したい対象者の情報）を入力し、登録する</h3>
    <br>
    <p>※旧字体・大文字・小文字・住所の表現などが少しでも異なっていると、閲覧申請は通りません。</p>
    <br>

  <!-- ①親情報（閲覧したい対象者の情報）登録フォーム -->
  <%= form_with model: ViewRequest.new, url: view_requests_path, method: :post, local: true do |f| %>
      <div>
        <%= f.label :first_name, "苗字" %>
        <%= f.text_field :first_name, name: "view_request[first_name]", required: true %>
      </div>
      <div>
        <%= f.label :first_name_furigana, "苗字（ふりがな）" %>
        <%= f.text_field :first_name_furigana, name: "view_request[first_name_furigana]", required: true %>
      </div>
      <div>
        <%= f.label :last_name, "名前" %>
        <%= f.text_field :last_name, name: "view_request[last_name]", required: true %>
      </div>
      <div>
        <%= f.label :last_name_furigana, "名前（ふりがな）" %>
        <%= f.text_field :last_name_furigana, name: "view_request[last_name_furigana]", required: true %>
      </div>
      <div>
        <%= f.label :birthday, "生年月日" %>
        <%= f.date_select :birthday, prefix: "view_request", start_year: 1900, end_year: Date.today.year, use_month_numbers: true %>
      </div>
      <div>
        <%= f.label :blood_type, "血液型" %>
        <%= f.select :blood_type, ["A", "B", "O", "AB"], include_blank: "選択してください", name: "view_request[blood_type]" %>
      </div>


      <br><br>公開者（親側）から見た、

      <div>
        <%= f.label :relationship, "閲覧者（あなた）の続柄" %>
        <%= f.select :relationship, ["夫", "妻", "長男", "二男", "三男", "長女", "二女", "三女", "本人の父母", "本人の兄弟", "その他"], include_blank: "選択してください" %>
      </div>


    <br>
    <%= f.submit "閲覧したい対象者を登録する", class: "btn btn-primary" %>
<br>
<br>
ーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーー
<br>
<br>


  <!-- ②登録済みの親情報（閲覧したい対象者の情報）リスト -->
  <h3>登録済みの親情報（閲覧したい対象者の情報）</h3>
  <% if current_user.view_requests.any? %>
    <table border="1">
      <tr>
        <th>苗字</th>
        <th>名前</th>
        <th>生年月日</th>
        <th>血液型</th>
        <th>削除</th>
      </tr>
      <% current_user.view_requests.each do |vr| %>
        <tr>
          <td><%= vr.first_name %> (<%= vr.first_name_furigana %>)</td>
          <td><%= vr.last_name %> (<%= vr.last_name_furigana %>)</td>
          <td><%= vr.birthday.strftime('%Y-%m-%d') %></td>
          <td><%= vr.blood_type %></td>
          <td>
            削除
          </td>
        </tr>
      <% end %>
    </table>
  <% else %>
    <p>現在、登録されている親情報（閲覧したい対象者の情報）はありません。</p>
  <% end %>


ーーー
<h3>登録リストから公開ページURLを取得</h3>
<% current_user.view_requests.each do |request| %>
  <p>
    <strong>閲覧許可した対象者:</strong> <%= request.first_name %> <%= request.last_name %>

      <!-- URLが未取得の場合、ボタンを表示 -->
       <%= button_to "公開ページURLを取得する", request_access_view_requests_path, 
          method: :post, params: { view_request_id: request.id }, class: "btn btn-primary" %>
  </p>
<% end %>
ーーー
ーーー
<% if current_user.view_accesses_as_viewer.any? %>
  <h3>閲覧許可済みリスト</h3>
  <table border="1">
    <tr>
      <th>公開者</th>
      <th>公開ページURL</th>
    </tr>
    <% current_user.view_accesses_as_viewer.each do |access| %>
      <tr>
        <td><%= access.owner.first_name %> <%= access.owner.last_name %></td>
        <td>
          <% if access.public_page_url.present? %>
            <%= link_to "公開ページを見る", access.public_page_url, target: "_blank" %>
          <% else %>
            URL未取得
            <% end %>
          </td>
        </tr>
      <% end %>
  </table>
<% else %>
  <p>閲覧許可された公開ページはありません。</p>
<% end %>
ーーー

  <br>
  <br>
ーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーー
<br>

    <% end %>
  </div>

  <!-- ２閲覧申請 -->
  <div id="result-section" style="display: none;">
    <h3>②登録リストから閲覧申請をかける</h3>
    <br>
    <p>※成功すると対象者の公開ページへアクセスし、失敗するとエラーが表示されます。</p>
    <p>※旧字体・大文字・小文字・住所の表現などが少しでも異なると、閲覧申請は通りません。</p>
    <p>※”親側の本人登録情報と完全一致” し、かつ ”親側が閲覧許可しているユーザー” のみ、閲覧ページにアクセスできます。</p>
    <br>
    <% if @searched_users.present? %>
      <ul>
        <% @searched_users.each do |user| %>
          <li><%= user.last_name %> <%= user.first_name %> さん</li>
        <% end %>
      </ul>
      <br>
      <%= button_to "このユーザーに閲覧申請する", request_access_path, method: :post, params: { user_id: @searched_users.first.id }, class: "btn btn-primary" %>
    <% else %>
      <p>一致するユーザーが見つかりませんでした。</p>
      <br>
ーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーー
<br>
    <% end %>
  </div>
</div>






 <!-- ##タブ機能 ------------------------------------------------->

<script>
  function showSection(type) {
    if (type === 'parent') {
      // 親側のタブを表示
      document.getElementById('parent-section').style.display = 'block';
      document.getElementById('child-section').style.display = 'none';

      // タブのアクティブ状態を変更
      document.getElementById('parent-tab').classList.add('active');
      document.getElementById('child-tab').classList.remove('active');

      // ✅ 親側の最初のタブ（情報変更タブ）をデフォルト表示
      showSubSection('info');

    } else {
      // 子側のタブを表示
      document.getElementById('parent-section').style.display = 'none';
      document.getElementById('child-section').style.display = 'block';

      // タブのアクティブ状態を変更
      document.getElementById('parent-tab').classList.remove('active');
      document.getElementById('child-tab').classList.add('active');

      // ✅ 親側のタブをすべて非表示
      document.getElementById('info-section').style.display = 'none';
      document.getElementById('permission-section').style.display = 'none';
      document.getElementById('notes-section').style.display = 'none';

      // ✅ 子側の最初のタブ（検索タブ）をデフォルト表示
      showChildSubSection('search');
    }
  }

  function showSubSection(type) {
    // 親側のタブを切り替え
    document.getElementById('info-section').style.display = type === 'info' ? 'block' : 'none';
    document.getElementById('permission-section').style.display = type === 'permission' ? 'block' : 'none';
    document.getElementById('notes-section').style.display = type === 'notes' ? 'block' : 'none';

    // タブのアクティブ状態を適切に変更
    document.getElementById('info-tab').classList.toggle('active', type === 'info');
    document.getElementById('permission-tab').classList.toggle('active', type === 'permission');
    document.getElementById('notes-tab').classList.toggle('active', type === 'notes');
  }

  function showChildSubSection(type) {
    // 子側のタブを切り替え
    document.getElementById('search-section').style.display = type === 'search' ? 'block' : 'none';
    document.getElementById('result-section').style.display = type === 'result' ? 'block' : 'none';

    // タブのアクティブ状態を適切に変更
    document.getElementById('search-tab').classList.toggle('active', type === 'search');
    document.getElementById('result-tab').classList.toggle('active', type === 'result');
  }
</script>



 <!-- ##CSS ----------------------------------------------------->
 
<style>
  .tabs button, .sub-tabs button {
    padding: 10px;
    margin: 5px;
    cursor: pointer;
  }
  .tabs button.active, .sub-tabs button.active {
    font-weight: bold;
  }
</style>